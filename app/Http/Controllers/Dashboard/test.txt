<?php

namespace App\Http\Controllers\Dashboard;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Hash;
use Illuminate\Validation\Rules\Password;
use App\Models\LaporanAkhir;
use Illuminate\Support\Facades\DB;
use App\Models\User;

class DashboardController extends Controller
{
    public function index()
    {
        $user = Auth::user();

        // Jika superadmin, tampilkan dashboard statistik
        if ($user->hasRole('superadmin')) {
            return $this->superadminDashboard();
        }

        // Jika OPD, tampilkan dashboard OPD
        if ($user->hasRole('opd')) {
            return $this->opdDashboard();
        }

        // Default dashboard
        return view('dashboard.index');
    }

    /**
     * Dashboard untuk Superadmin
     */
    protected function superadminDashboard()
    {
        // Total Laporan
        $totalLaporan = LaporanAkhir::count();
    
        // Laporan berdasarkan Status
        $laporanDiajukan = LaporanAkhir::where('status', 'diajukan')->count();
        $laporanDisetujui = LaporanAkhir::where('status', 'disetujui')->count();
        $laporanDirevisi = LaporanAkhir::where('status', 'direvisi')->count();
        $laporanDitolak = LaporanAkhir::where('status', 'ditolak')->count();
    
        // Laporan per Tahun
        $laporanPerTahun = LaporanAkhir::select(
                DB::raw('tahun_pelaksanaan as tahun'),
                DB::raw('COUNT(*) as total')
            )
            ->groupBy('tahun_pelaksanaan')
            ->orderBy('tahun_pelaksanaan')
            ->get();
    
        // Hitung Growth Percentage (perbandingan tahun ini vs tahun lalu)
        $tahunIni = date('Y');
        $tahunLalu = $tahunIni - 1;
        $laporanTahunIni = LaporanAkhir::where('tahun_pelaksanaan', $tahunIni)->count();
        $laporanTahunLalu = LaporanAkhir::where('tahun_pelaksanaan', $tahunLalu)->count();
        
        if ($laporanTahunLalu > 0) {
            $growthPercentage = round((($laporanTahunIni - $laporanTahunLalu) / $laporanTahunLalu) * 100, 1);
        } else {
            $growthPercentage = $laporanTahunIni > 0 ? 100 : 0;
        }
    
        // Top 5 OPD
        $topOpd = LaporanAkhir::select('user_id', DB::raw('COUNT(*) as total'))
            ->with('user:id,nama_opd')
            ->groupBy('user_id')
            ->orderByDesc('total')
            ->limit(5)
            ->get()
            ->map(function ($item) {
                return (object) [
                    'nama_opd' => $item->user->nama_opd ?? 'N/A',
                    'total' => $item->total
                ];
            });
    
        // Total Users (OPD)
        $totalUsers = User::role('opd')->count();
    
        // Total Anggaran
        $totalAnggaran = LaporanAkhir::sum('anggaran');
        $totalAnggaranFormatted = 'Rp ' . number_format($totalAnggaran / 1000000000, 2) . ' M';
    
        // Rata-rata Realisasi
        $rataRealisasi = LaporanAkhir::avg('persentase_realisasi') ?? 0;
    
        // Total Jenis Kegiatan (unique)
        $totalJenisKegiatan = LaporanAkhir::distinct('jenis_kegiatan')->count('jenis_kegiatan');
    
        // Laporan Terbaru (Semua)
        $laporanTerbaru = LaporanAkhir::with('user:id,nama_opd')
            ->latest()
            ->limit(10)
            ->get();
    
        // Laporan Pending (Status: diajukan)
        $laporanPending = LaporanAkhir::with('user:id,nama_opd')
            ->where('status', 'diajukan')
            ->latest()
            ->limit(10)
            ->get();
    
        // Laporan Approved (Status: disetujui)
        $laporanApproved = LaporanAkhir::with('user:id,nama_opd')
            ->where('status', 'disetujui')
            ->latest()
            ->limit(10)
            ->get();
    
        return view('dashboard.superadmin', compact(
            'totalLaporan',
            'laporanDiajukan',
            'laporanDisetujui',
            'laporanDirevisi',
            'laporanDitolak',
            'laporanPerTahun',
            'growthPercentage',
            'topOpd',
            'totalUsers',
            'totalAnggaran',
            'totalAnggaranFormatted',
            'rataRealisasi',
            'totalJenisKegiatan',
            'laporanTerbaru',
            'laporanPending',
            'laporanApproved'
        ));
    }
    /**
     * Dashboard untuk OPD
     */
    protected function opdDashboard()
{
    $userId = Auth::id();

    // Total Laporan OPD ini
    $totalLaporan = LaporanAkhir::where('user_id', $userId)->count();

    // Laporan berdasarkan Status
    $laporanDiajukan = LaporanAkhir::where('user_id', $userId)
        ->where('status', 'diajukan')
        ->count();
    
    $laporanDisetujui = LaporanAkhir::where('user_id', $userId)
        ->where('status', 'disetujui')
        ->count();
    
    $laporanDirevisi = LaporanAkhir::where('user_id', $userId)
        ->where('status', 'direvisi')
        ->count();
    
    $laporanDitolak = LaporanAkhir::where('user_id', $userId)
        ->where('status', 'ditolak')
        ->count();

    // Laporan per Tahun (untuk OPD ini)
    $laporanPerTahun = LaporanAkhir::select(
            DB::raw('tahun_pelaksanaan as tahun'),
            DB::raw('COUNT(*) as total')
        )
        ->where('user_id', $userId)
        ->groupBy('tahun_pelaksanaan')
        ->orderBy('tahun_pelaksanaan')
        ->get();

    // Hitung Growth Percentage (perbandingan tahun ini vs tahun lalu)
    $tahunIni = date('Y');
    $tahunLalu = $tahunIni - 1;
    $laporanTahunIni = LaporanAkhir::where('user_id', $userId)
        ->where('tahun_pelaksanaan', $tahunIni)
        ->count();
    $laporanTahunLalu = LaporanAkhir::where('user_id', $userId)
        ->where('tahun_pelaksanaan', $tahunLalu)
        ->count();
    
    if ($laporanTahunLalu > 0) {
        $growthPercentage = round((($laporanTahunIni - $laporanTahunLalu) / $laporanTahunLalu) * 100, 1);
    } else {
        $growthPercentage = $laporanTahunIni > 0 ? 100 : 0;
    }

    // Top 5 Jenis Kegiatan (untuk OPD ini)
    $topJenisKegiatan = LaporanAkhir::select('jenis_kegiatan', DB::raw('COUNT(*) as total'))
        ->where('user_id', $userId)
        ->groupBy('jenis_kegiatan')
        ->orderByDesc('total')
        ->limit(5)
        ->get()
        ->map(function ($item) {
            return (object) [
                'jenis_kegiatan' => $item->jenis_kegiatan,
                'total' => $item->total
            ];
        });

    // Total Anggaran
    $totalAnggaran = LaporanAkhir::where('user_id', $userId)->sum('anggaran');
    $totalAnggaranFormatted = 'Rp ' . number_format($totalAnggaran / 1000000000, 2) . ' M';

    // Rata-rata Realisasi
    $rataRealisasi = LaporanAkhir::where('user_id', $userId)->avg('persentase_realisasi') ?? 0;

    // Total Jenis Kegiatan (unique untuk OPD ini)
    $totalJenisKegiatan = LaporanAkhir::where('user_id', $userId)
        ->distinct('jenis_kegiatan')
        ->count('jenis_kegiatan');

    // Total Anggaran yang Terealisasi
    $totalRealisasi = LaporanAkhir::where('user_id', $userId)
        ->sum(DB::raw('(anggaran * persentase_realisasi) / 100'));
    $totalRealisasiFormatted = 'Rp ' . number_format($totalRealisasi / 1000000000, 2) . ' M';

    // Laporan Terbaru (Semua)
    $laporanTerbaru = LaporanAkhir::where('user_id', $userId)
        ->latest()
        ->limit(10)
        ->get();

    // Laporan Pending (Status: diajukan)
    $laporanPending = LaporanAkhir::where('user_id', $userId)
        ->where('status', 'diajukan')
        ->latest()
        ->limit(10)
        ->get();

    // Laporan Approved (Status: disetujui)
    $laporanApproved = LaporanAkhir::where('user_id', $userId)
        ->where('status', 'disetujui')
        ->latest()
        ->limit(10)
        ->get();

    // Laporan per Bulan (Tahun ini)
    $laporanPerBulan = LaporanAkhir::select(
            DB::raw('MONTH(created_at) as bulan'),
            DB::raw('COUNT(*) as total')
        )
        ->where('user_id', $userId)
        ->whereYear('created_at', date('Y'))
        ->groupBy('bulan')
        ->orderBy('bulan')
        ->get()
        ->map(function ($item) {
            $bulanNama = [
                1 => 'Jan', 2 => 'Feb', 3 => 'Mar', 4 => 'Apr',
                5 => 'Mei', 6 => 'Jun', 7 => 'Jul', 8 => 'Agu',
                9 => 'Sep', 10 => 'Okt', 11 => 'Nov', 12 => 'Des'
            ];
            return [
                'bulan' => $bulanNama[$item->bulan],
                'total' => $item->total
            ];
        });

    return view('dashboard.opd', compact(
        'totalLaporan',
        'laporanDiajukan',
        'laporanDisetujui',
        'laporanDirevisi',
        'laporanDitolak',
        'laporanPerTahun',
        'growthPercentage',
        'topJenisKegiatan',
        'totalAnggaran',
        'totalAnggaranFormatted',
        'rataRealisasi',
        'totalJenisKegiatan',
        'totalRealisasi',
        'totalRealisasiFormatted',
        'laporanTerbaru',
        'laporanPending',
        'laporanApproved',
        'laporanPerBulan'
    ));
}

    public function showChangePasswordForm()
    {
        return view('dashboard.change-password');
    }

    public function changePassword(Request $request)
    {
        $request->validate([
            'current_password' => 'required',
            'password' => ['required', 'confirmed', Password::min(8)->mixedCase()->numbers()],
        ]);

        $user = Auth::user();

        // Check if current password is correct
        if (!Hash::check($request->current_password, $user->password)) {
            return back()->withErrors(['current_password' => 'Password lama tidak sesuai.']);
        }

        // Update password
        $user->update([
            'password' => Hash::make($request->password),
        ]);

        return back()->with('success', 'Password berhasil diubah!');
    }

    public function showChangePasswordFormOpd()
    {
        return view('dashboard.change-password-opd');
    }

    public function changePasswordOpd(Request $request)
    {
        $request->validate([
            'current_password' => 'required',
            'password' => ['required', 'confirmed', Password::min(8)->mixedCase()->numbers()],
        ]);

        $user = Auth::user();

        // Check if current password is correct
        if (!Hash::check($request->current_password, $user->password)) {
            return back()->withErrors(['current_password' => 'Password lama tidak sesuai.']);
        }

        // Update password
        $user->update([
            'password' => Hash::make($request->password),
        ]);

        return back()->with('success', 'Password berhasil diubah!');
    }
}
